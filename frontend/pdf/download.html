<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Download Your Merged PDF | CanIEdit</title>
  <meta name="description" content="Your merged PDF is ready. Download it now or run another merge with CanIEdit." />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="icon" href="/assets/images/CanIEdit_(64x64px).png" type="image/png" sizes="64x64" />
  <link rel="prefetch" href="../partials/header.html" as="fetch" crossorigin="anonymous" />
  <link rel="prefetch" href="../partials/footer.html" as="fetch" crossorigin="anonymous" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            brand: "#2563eb",
            brandDark: "#1d4ed8",
            brandAccent: "#14b8a6"
          },
          boxShadow: {
            card: "0 20px 45px rgba(15, 23, 42, 0.08)"
          },
          fontFamily: {
            sans: ["Inter", "Segoe UI", "system-ui", "-apple-system", "sans-serif"]
          }
        }
      }
    };
  </script>
</head>
<body class="flex min-h-screen flex-col bg-slate-50 font-sans text-slate-900">
  <div id="header"></div>

  <main class="flex-1">
    <section class="bg-white">
      <div class="mx-auto max-w-6xl px-4 py-16" aria-labelledby="download-heading">
        <div class="grid gap-10 lg:grid-cols-[1.3fr,0.7fr]">
          <div class="flex flex-col gap-8 rounded-3xl border border-slate-200 bg-white p-8 shadow-card">
            <div class="space-y-4">
              <h1 id="download-heading" class="text-3xl font-bold text-slate-900 sm:text-4xl">Your merged PDF is ready</h1>
              <p id="downloadStatus" class="rounded-3xl border border-slate-200 bg-slate-50 px-5 py-4 text-sm font-semibold text-slate-600">We are preparing your secure download link. This page will refresh the link if it expires.</p>
            </div>
            <div class="flex flex-wrap gap-3">
              <a id="downloadButton" class="inline-flex items-center justify-center rounded-lg bg-brand px-6 py-3 text-sm font-semibold text-white shadow-sm transition hover:bg-brandDark" href="#">Download again</a>
              <a class="inline-flex items-center justify-center rounded-lg border border-slate-200 px-6 py-3 text-sm font-semibold text-slate-800 transition hover:border-brand hover:text-brand" href="/pdf/merge.html">Merge another PDF</a>
            </div>
            <div class="grid gap-3 sm:grid-cols-2" role="group" aria-label="Save or share your merged PDF">
              <button id="googleDriveButton" type="button" class="inline-flex items-center justify-center rounded-lg border border-slate-200 bg-white px-4 py-3 text-sm font-semibold text-slate-700 transition hover:border-brand hover:text-brand">Add to Google Drive</button>
              <button id="dropboxButton" type="button" class="inline-flex items-center justify-center rounded-lg border border-slate-200 bg-white px-4 py-3 text-sm font-semibold text-slate-700 transition hover:border-brand hover:text-brand">Add to Dropbox</button>
              <button id="copyLinkButton" type="button" class="inline-flex items-center justify-center rounded-lg border border-slate-200 bg-white px-4 py-3 text-sm font-semibold text-slate-700 transition hover:border-brand hover:text-brand">Copy download link</button>
              <button id="deleteFileButton" type="button" class="inline-flex items-center justify-center rounded-lg border border-rose-200 bg-rose-50 px-4 py-3 text-sm font-semibold text-rose-600 transition hover:border-rose-300 hover:bg-rose-100">Delete now</button>
            </div>
            <p class="text-sm font-medium text-slate-600">Need larger files or bulk merges? <a class="text-brand hover:text-brandDark" href="/pricing.html">Upgrade for higher limits.</a></p>
          </div>
          <div class="flex flex-col gap-2 rounded-3xl border border-dashed border-slate-300 bg-slate-50 p-8 text-center shadow-sm" aria-label="Download hero ad placeholder">
            <strong class="text-base font-semibold text-slate-900">AdSense 970×250</strong>
            <span class="text-sm text-slate-600">Promote upgrades, partner offers, or onboarding flows here.</span>
          </div>
        </div>

        <div class="mt-16 grid gap-10 lg:grid-cols-[0.65fr,1.35fr]" aria-label="More options">
          <aside class="space-y-6">
            <div class="flex flex-col gap-2 rounded-3xl border border-dashed border-slate-300 bg-slate-50 p-6 text-center shadow-sm" aria-label="Download sidebar ad placeholder">
              <strong class="text-base font-semibold text-slate-900">AdSense 300×600</strong>
              <span class="text-sm text-slate-600">Drive conversions with contextual ads or tutorials.</span>
            </div>
            <div class="flex flex-col gap-2 rounded-3xl border border-dashed border-slate-300 bg-slate-50 p-6 text-center shadow-sm" aria-label="Secondary ad placeholder">
              <strong class="text-base font-semibold text-slate-900">AdSense 300×250</strong>
              <span class="text-sm text-slate-600">Highlight newsletters, premium add-ons, or affiliate offers.</span>
            </div>
          </aside>
          <div class="rounded-3xl border border-slate-200 bg-white p-8 shadow-card">
            <h2 class="text-2xl font-semibold text-slate-900">Next steps</h2>
            <ul class="mt-5 space-y-3 text-sm text-slate-600">
              <li class="flex items-start gap-2"><span class="mt-1 h-2 w-2 rounded-full bg-brand"></span>Files are automatically deleted from our servers within minutes.</li>
              <li class="flex items-start gap-2"><span class="mt-1 h-2 w-2 rounded-full bg-brand"></span>Save to your cloud drive or send directly to clients once downloaded.</li>
              <li class="flex items-start gap-2"><span class="mt-1 h-2 w-2 rounded-full bg-brand"></span>Run another merge to reorder pages or prepare signature packets.</li>
            </ul>
            <a class="mt-6 inline-flex items-center justify-center rounded-lg border border-slate-200 px-5 py-3 text-sm font-semibold text-slate-800 transition hover:border-brand hover:text-brand" href="/pricing.html#plans">Compare plans for higher limits</a>
          </div>
        </div>
      </div>
    </section>
  </main>

  <noscript>
    <p class="px-4 py-4 text-center text-sm text-slate-600">Enable JavaScript to keep your download link fresh.</p>
  </noscript>

  <div id="footer"></div>

  <script>
    (function () {
      const params = new URLSearchParams(window.location.search);
      const file = params.get("file");
      const status = document.getElementById("downloadStatus");
      const downloadButton = document.getElementById("downloadButton");
      const googleDriveButton = document.getElementById("googleDriveButton");
      const dropboxButton = document.getElementById("dropboxButton");
      const copyLinkButton = document.getElementById("copyLinkButton");
      const deleteFileButton = document.getElementById("deleteFileButton");
      const API_BASE = "https://api.caniedit.in";
      const safePattern = /^[\w.-]+$/;

      const BUTTON_DISABLED_CLASSES = ["pointer-events-none", "opacity-60", "grayscale"];
      const SECONDARY_DISABLED_CLASSES = ["opacity-60", "cursor-not-allowed"];

      if (!file || !safePattern.test(file)) {
        status.textContent = "The download link is missing. Merge another PDF to get started.";
        downloadButton.classList.add(...BUTTON_DISABLED_CLASSES);
        downloadButton.setAttribute("aria-disabled", "true");
        downloadButton.removeAttribute("href");
        return;
      }

      const downloadUrl = `${API_BASE}/temp_outputs/${file}`;
      downloadButton.href = downloadUrl;

      let isDownloading = false;
      let lastObjectUrl = null;
      let fileDeleted = false;

      const disableDownloadActions = () => {
        downloadButton.classList.add(...BUTTON_DISABLED_CLASSES);
        downloadButton.setAttribute("aria-disabled", "true");
        downloadButton.removeAttribute("href");
        [googleDriveButton, dropboxButton, copyLinkButton, deleteFileButton].forEach((btn) => {
          if (!btn) return;
          btn.disabled = true;
          btn.classList.add(...SECONDARY_DISABLED_CLASSES);
        });
      };

      const triggerDownload = async () => {
        if (isDownloading || fileDeleted) {
          return;
        }
        isDownloading = true;
        downloadButton.setAttribute("aria-busy", "true");
        status.textContent = "Starting your download…";

        try {
          const response = await fetch(downloadUrl, { mode: "cors" });
          if (!response.ok) {
            throw new Error(`Download failed with status ${response.status}`);
          }

          const blob = await response.blob();
          if (lastObjectUrl) {
            URL.revokeObjectURL(lastObjectUrl);
          }

          const objectUrl = URL.createObjectURL(blob);
          lastObjectUrl = objectUrl;

          const anchor = document.createElement("a");
          anchor.href = objectUrl;
          anchor.download = file.toLowerCase().endsWith(".pdf") ? file : `${file}.pdf`;
          anchor.style.display = "none";
          document.body.appendChild(anchor);
          anchor.click();
          anchor.remove();

          status.textContent = "Download started. Check your downloads folder.";

          setTimeout(() => {
            URL.revokeObjectURL(objectUrl);
            if (lastObjectUrl === objectUrl) {
              lastObjectUrl = null;
            }
          }, 3000);
        } catch (error) {
          console.error(error);
          status.textContent = "We could not start the download automatically. Click the button again to retry.";
          isDownloading = false;
          downloadButton.removeAttribute("aria-busy");
          downloadButton.classList.remove(...BUTTON_DISABLED_CLASSES);
          downloadButton.href = downloadUrl;
          return;
        }

        isDownloading = false;
        downloadButton.removeAttribute("aria-busy");
        downloadButton.classList.remove(...BUTTON_DISABLED_CLASSES);
        downloadButton.href = downloadUrl;
      };

      status.textContent = "Preparing your secure download link…";
      triggerDownload();

      downloadButton.addEventListener("click", (event) => {
        event.preventDefault();
        triggerDownload();
      });

      if (googleDriveButton) {
        googleDriveButton.addEventListener("click", () => {
          if (fileDeleted) return;
          window.open("https://drive.google.com/drive/my-drive", "_blank", "noopener");
          status.textContent = "Opened Google Drive in a new tab. Upload the downloaded file to your Drive.";
        });
      }

      if (dropboxButton) {
        dropboxButton.addEventListener("click", () => {
          if (fileDeleted) return;
          window.open("https://www.dropbox.com/home", "_blank", "noopener");
          status.textContent = "Opened Dropbox in a new tab. Upload the downloaded file to your Dropbox.";
        });
      }

      if (copyLinkButton) {
        copyLinkButton.addEventListener("click", async () => {
          if (fileDeleted) return;
          try {
            await navigator.clipboard.writeText(downloadUrl);
            status.textContent = "Secure download link copied to clipboard.";
          } catch (error) {
            console.error(error);
            const tempInput = document.createElement("input");
            tempInput.value = downloadUrl;
            tempInput.style.position = "absolute";
            tempInput.style.left = "-9999px";
            document.body.appendChild(tempInput);
            tempInput.select();

            let fallbackSucceeded = false;
            try {
              fallbackSucceeded = typeof document.execCommand === "function" && document.execCommand("copy");
            } catch (execError) {
              console.error(execError);
            }
            document.body.removeChild(tempInput);

            if (fallbackSucceeded) {
              status.textContent = "Secure download link copied to clipboard.";
              return;
            }

            status.textContent = "Unable to copy automatically. Highlight and copy this link: " + downloadUrl;
          }
        });
      }

      if (deleteFileButton) {
        deleteFileButton.addEventListener("click", async () => {
          if (fileDeleted) return;
          deleteFileButton.disabled = true;
          deleteFileButton.setAttribute("aria-busy", "true");
          status.textContent = "Requesting immediate deletion…";

          try {
            const endpoint = `${API_BASE}/api/pdf/merge/${encodeURIComponent(file)}`;
            const response = await fetch(endpoint, { method: "DELETE" });
            if (!response.ok) {
              throw new Error(`Unable to delete file (${response.status})`);
            }

            fileDeleted = true;
            status.textContent = "File deleted from the server. Refresh to start a new merge.";
            disableDownloadActions();
          } catch (error) {
            console.error(error);
            status.textContent = "We couldn't delete the file right now. Try again in a moment.";
            deleteFileButton.disabled = false;
            deleteFileButton.removeAttribute("aria-busy");
            deleteFileButton.classList.remove(...SECONDARY_DISABLED_CLASSES);
            return;
          }

          deleteFileButton.removeAttribute("aria-busy");
        });
      }

      window.addEventListener("beforeunload", () => {
        if (lastObjectUrl) {
          URL.revokeObjectURL(lastObjectUrl);
        }
      });
    })();
  </script>

  <script src="../assets/include.js"></script>
</body>
</html>
